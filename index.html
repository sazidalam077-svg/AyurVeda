<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>üåø AyurVeda AI</title>
<style>
:root {
  --bg:#F5F0E6;--bg2:#EDE7D9;--card:#FDFAF4;--green:#4F6F52;--green2:#3d5940;
  --brown:#8B6F47;--vata:#7C9CBF;--pitta:#C4714A;--kapha:#7BAE84;
  --text:#2C2416;--muted:#8A7A62;--border:#DDD5C0;--warn:#C4714A;--r:14px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);font-family:Georgia,serif;color:var(--text);min-height:100vh}
h1,h2,h3,h4{font-family:Georgia,serif;font-weight:400}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg2)}::-webkit-scrollbar-thumb{background:var(--brown);border-radius:3px}
.shell{display:flex;min-height:100vh}
.sidebar{width:230px;min-height:100vh;background:var(--green);color:#fff;display:flex;flex-direction:column;position:fixed;top:0;left:0;z-index:100}
.sb-logo{padding:24px 20px 20px;border-bottom:1px solid rgba(255,255,255,.15)}
.sb-logo h1{font-size:1.45rem;color:#fff}
.sb-logo small{font-family:Arial,sans-serif;font-size:.68rem;opacity:.6;letter-spacing:1px;text-transform:uppercase}
.sb-nav{flex:1;padding:12px 0}
.nav-item{display:flex;align-items:center;gap:10px;padding:11px 20px;cursor:pointer;font-family:Arial,sans-serif;font-size:.86rem;color:rgba(255,255,255,.8);border-left:3px solid transparent;transition:background .15s}
.nav-item:hover{background:rgba(255,255,255,.1);color:#fff}
.nav-item.active{background:rgba(255,255,255,.15);color:#fff;border-left-color:#B5D5A8}
.sb-user{padding:14px 20px;border-top:1px solid rgba(255,255,255,.15);font-family:Arial,sans-serif}
.sb-av{width:33px;height:33px;background:rgba(255,255,255,.25);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.95rem;margin-right:10px;flex-shrink:0}
.main{margin-left:230px;flex:1;padding:30px 34px;min-height:100vh}
.auth-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--bg),var(--bg2))}
.auth-box{background:var(--card);border-radius:var(--r);padding:42px;width:400px;box-shadow:0 4px 32px rgba(79,111,82,.12);border:1px solid var(--border)}
.auth-box h1{font-size:1.9rem;color:var(--green);text-align:center;margin-bottom:6px}
.auth-box .sub{text-align:center;color:var(--muted);font-size:.87rem;margin-bottom:26px;font-family:Arial,sans-serif}
.fg{margin-bottom:14px}
label{display:block;font-family:Arial,sans-serif;font-size:.73rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
input[type=text],input[type=email],input[type=password],input[type=number],select{width:100%;padding:10px 13px;border:1.5px solid var(--border);border-radius:9px;background:var(--bg);font-family:Arial,sans-serif;font-size:.87rem;color:var(--text);outline:none;transition:border-color .2s}
input:focus,select:focus{border-color:var(--green);box-shadow:0 0 0 3px rgba(79,111,82,.1)}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:10px 20px;border-radius:9px;font-family:Arial,sans-serif;font-size:.86rem;font-weight:600;cursor:pointer;border:none;transition:all .18s;text-decoration:none}
.btn-p{background:var(--green);color:#fff}
.btn-p:hover{background:var(--green2);transform:translateY(-1px);box-shadow:0 4px 14px rgba(79,111,82,.28)}
.btn-o{background:transparent;color:var(--green);border:1.5px solid var(--green)}
.btn-o:hover{background:var(--green);color:#fff}
.btn-sm{padding:7px 13px;font-size:.79rem}
.btn-full{width:100%;justify-content:center}
.btn-red{background:rgba(196,113,74,.1);color:var(--warn);border:none}
.btn-red:hover{background:rgba(196,113,74,.2)}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none !important;box-shadow:none !important}
.card{background:var(--card);border-radius:var(--r);border:1px solid var(--border);padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.ct{font-size:1.15rem;color:var(--text);margin-bottom:3px}
.cs{font-size:.81rem;color:var(--muted);margin-bottom:16px;font-family:Arial,sans-serif}
.ph{margin-bottom:26px}
.ph h2{font-size:1.85rem;color:var(--text)}
.ph p{color:var(--muted);margin-top:3px;font-family:Arial,sans-serif;font-size:.88rem}
.stat{background:var(--card);border-radius:var(--r);border:1px solid var(--border);padding:16px 20px}
.sl{font-family:Arial,sans-serif;font-size:.72rem;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:6px}
.sv{font-size:1.8rem;color:var(--text)}
.su{font-size:.78rem;color:var(--muted)}
.pb{height:5px;background:var(--bg2);border-radius:3px}
.pf{height:100%;border-radius:3px;transition:width .4s;background:var(--green)}
.db{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:.74rem;font-weight:600;font-family:Arial,sans-serif}
.dv{background:rgba(124,156,191,.15);color:#4B7BAE}
.dp{background:rgba(196,113,74,.15);color:var(--pitta)}
.dk{background:rgba(123,174,132,.15);color:#4A8E5A}
.fi{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;background:var(--bg);border-radius:9px;border:1px solid var(--border);margin-bottom:7px;transition:border-color .15s}
.fi:hover{border-color:var(--green)}
.fn{font-weight:600;font-size:.88rem}
.fm{display:flex;gap:10px;font-family:Arial,sans-serif;font-size:.76rem;color:var(--muted);margin-top:2px}
.al{border-radius:9px;padding:12px 14px;margin-bottom:14px;font-family:Arial,sans-serif;font-size:.84rem;display:flex;gap:8px;align-items:flex-start}
.aw{background:rgba(196,113,74,.1);border:1px solid rgba(196,113,74,.25);color:#a05030}
.as{background:rgba(79,111,82,.1);border:1px solid rgba(79,111,82,.25);color:var(--green2)}
.ai{background:rgba(124,156,191,.1);border:1px solid rgba(124,156,191,.3);color:#3d6a9e}
.qcard{background:var(--card);border-radius:var(--r);border:1px solid var(--border);padding:24px;margin-bottom:16px}
.qt{font-size:1.2rem;margin-bottom:16px}
.og{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.ob{padding:13px 13px;border-radius:10px;border:1.5px solid var(--border);background:var(--bg);cursor:pointer;text-align:left;font-family:Arial,sans-serif;font-size:.83rem;transition:all .18s;color:var(--text);width:100%}
.ob:hover{border-color:var(--green);background:rgba(79,111,82,.05)}
.ob.sel{border-color:var(--green);background:rgba(79,111,82,.1);color:var(--green);font-weight:600}
.ol{font-size:.67rem;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:2px}
.drc{border-radius:var(--r);padding:28px;text-align:center;background:linear-gradient(135deg,#EDF5EE,#F5F0E6);border:1px solid rgba(79,111,82,.2);margin-bottom:18px}
.di{font-size:3rem;margin-bottom:8px}
.dn{font-size:2rem;color:var(--green);margin-bottom:6px}
.sb2{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:18px}
.sbi{text-align:center}
.sbl{font-family:Arial,sans-serif;font-size:.76rem;color:var(--muted);margin-bottom:5px;font-weight:600}
.sbt{height:7px;background:var(--bg2);border-radius:4px;margin-bottom:4px}
.sbf{height:100%;border-radius:4px}
.sbf.vata{background:var(--vata)}.sbf.pitta{background:var(--pitta)}.sbf.kapha{background:var(--kapha)}
.spct{font-size:1.1rem;font-weight:600}
.sz{border:2px dashed var(--border);border-radius:var(--r);padding:40px;text-align:center;cursor:pointer;background:var(--bg);transition:all .2s}
.sz:hover{border-color:var(--green);background:rgba(79,111,82,.04)}
.sz.sc{border-color:var(--green);animation:pulse 1.4s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.si{font-size:2.5rem;margin-bottom:12px}
.li{display:flex;align-items:center;justify-content:space-between;padding:10px 13px;background:var(--bg);border-radius:9px;border:1px solid var(--border)}
.lt{font-family:Arial,sans-serif;font-size:.74rem;color:var(--muted)}
.land{min-height:100vh;background:linear-gradient(150deg,var(--bg),var(--bg2))}
.lnav{display:flex;justify-content:space-between;align-items:center;padding:20px 52px;max-width:1040px;margin:0 auto}
.llogo{font-size:1.55rem;color:var(--green)}
.hero{padding:52px 52px 36px;max-width:1040px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:52px;align-items:center}
.htag{display:inline-block;background:rgba(79,111,82,.1);color:var(--green);padding:5px 13px;border-radius:20px;font-size:.75rem;font-weight:600;margin-bottom:16px;text-transform:uppercase;letter-spacing:.5px;font-family:Arial,sans-serif}
.htitle{font-size:2.8rem;line-height:1.15;margin-bottom:16px}
.htitle span{color:var(--green)}
.hsub{font-family:Arial,sans-serif;font-size:.95rem;color:var(--muted);line-height:1.7;margin-bottom:28px}
.hbtns{display:flex;gap:12px;flex-wrap:wrap}
.hcard{background:var(--card);border-radius:18px;border:1px solid var(--border);padding:26px;box-shadow:0 5px 28px rgba(79,111,82,.1)}
.features{padding:0 52px 64px;max-width:1040px;margin:0 auto}
.fg2{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:24px}
.fc{background:var(--card);border-radius:var(--r);padding:22px;border:1px solid var(--border)}
.ficon{font-size:1.7rem;margin-bottom:9px}
.ftitle{font-size:.98rem;margin-bottom:6px}
.fdesc{font-family:Arial,sans-serif;font-size:.81rem;color:var(--muted);line-height:1.6}
.pav{width:68px;height:68px;background:linear-gradient(135deg,var(--green),var(--brown));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2rem;margin-bottom:12px}
.toast{position:fixed;bottom:20px;right:20px;background:var(--text);color:#fff;padding:12px 16px;border-radius:9px;font-family:Arial,sans-serif;font-size:.84rem;z-index:9999;animation:slideUp .26s ease;box-shadow:0 4px 16px rgba(0,0,0,.2)}
@keyframes slideUp{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
.divider{height:1px;background:var(--border);margin:16px 0}
.flex{display:flex}.aic{align-items:center}.jb{justify-content:space-between}.gap2{gap:8px}.gap3{gap:12px}.wrap{flex-wrap:wrap}
.mt2{margin-top:8px}.mt3{margin-top:12px}.mt4{margin-top:16px}.mb2{margin-bottom:8px}
@media(max-width:820px){
  .sidebar{display:none}.main{margin-left:0;padding:18px 14px}
  .g2,.g3,.g4,.og,.sb2,.fg2{grid-template-columns:1fr}
  .hero{grid-template-columns:1fr;padding:28px 18px}.features{padding:0 18px 44px}
  .htitle{font-size:2rem}.lnav{padding:16px 18px}
}
</style>
</head>
<body>
<div id="app"></div>
<script>
// ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FOODS=[
  {id:1,name:"Moong Dal Khichdi",cal:220,protein:10,carbs:38,fats:4,vata:"pacify",pitta:"pacify",kapha:"neutral",e:"üç≤"},
  {id:2,name:"Masala Dosa",cal:320,protein:8,carbs:45,fats:12,vata:"neutral",pitta:"aggravate",kapha:"aggravate",e:"ü´ì"},
  {id:3,name:"Curd Rice",cal:200,protein:7,carbs:35,fats:5,vata:"pacify",pitta:"pacify",kapha:"aggravate",e:"üçö"},
  {id:4,name:"Paneer Sabzi",cal:280,protein:14,carbs:10,fats:18,vata:"pacify",pitta:"aggravate",kapha:"neutral",e:"üßÄ"},
  {id:5,name:"Chapati",cal:100,protein:3,carbs:20,fats:2,vata:"neutral",pitta:"neutral",kapha:"pacify",e:"ü´ì"},
  {id:6,name:"Idli",cal:130,protein:4,carbs:25,fats:1,vata:"neutral",pitta:"pacify",kapha:"neutral",e:"‚ö™"},
  {id:7,name:"Rajma",cal:260,protein:13,carbs:38,fats:5,vata:"aggravate",pitta:"neutral",kapha:"pacify",e:"ü´ò"},
  {id:8,name:"Upma",cal:200,protein:5,carbs:32,fats:7,vata:"pacify",pitta:"neutral",kapha:"pacify",e:"üçõ"},
  {id:9,name:"Coconut Water",cal:45,protein:0,carbs:11,fats:0,vata:"pacify",pitta:"pacify",kapha:"neutral",e:"ü••"},
  {id:10,name:"Dal Tadka",cal:180,protein:9,carbs:28,fats:4,vata:"pacify",pitta:"pacify",kapha:"pacify",e:"üçú"},
  {id:11,name:"Poha",cal:165,protein:4,carbs:32,fats:4,vata:"pacify",pitta:"neutral",kapha:"pacify",e:"üçΩ"},
  {id:12,name:"Ragi Dosa",cal:170,protein:5,carbs:30,fats:4,vata:"pacify",pitta:"neutral",kapha:"pacify",e:"ü´ì"},
  {id:13,name:"Palak Paneer",cal:250,protein:12,carbs:12,fats:16,vata:"pacify",pitta:"aggravate",kapha:"neutral",e:"ü•¨"},
  {id:14,name:"Sambar",cal:150,protein:8,carbs:20,fats:4,vata:"pacify",pitta:"neutral",kapha:"pacify",e:"üçú"},
  {id:15,name:"Aloo Gobi",cal:200,protein:5,carbs:28,fats:8,vata:"pacify",pitta:"neutral",kapha:"neutral",e:"ü•î"},
  {id:16,name:"Methi Roti",cal:110,protein:4,carbs:18,fats:3,vata:"neutral",pitta:"pacify",kapha:"pacify",e:"üåø"},
  {id:17,name:"Buttermilk",cal:40,protein:3,carbs:5,fats:1,vata:"pacify",pitta:"pacify",kapha:"neutral",e:"ü•õ"},
  {id:18,name:"Banana",cal:90,protein:1,carbs:23,fats:0,vata:"pacify",pitta:"pacify",kapha:"aggravate",e:"üçå"},
  {id:19,name:"Papaya",cal:55,protein:1,carbs:14,fats:0,vata:"pacify",pitta:"neutral",kapha:"pacify",e:"üü†"},
  {id:20,name:"Green Salad",cal:50,protein:2,carbs:8,fats:2,vata:"aggravate",pitta:"pacify",kapha:"pacify",e:"ü•ó"},
];
const QUESTIONS=[
  {id:"frame",text:"What is your body frame?",opts:[{l:"Vata",t:"Thin, light, bony",d:"vata"},{l:"Pitta",t:"Medium, muscular",d:"pitta"},{l:"Kapha",t:"Broad, heavy-set",d:"kapha"}]},
  {id:"skin",text:"How would you describe your skin?",opts:[{l:"Vata",t:"Dry, rough, cold",d:"vata"},{l:"Pitta",t:"Oily, warm, reddish",d:"pitta"},{l:"Kapha",t:"Smooth, thick, pale",d:"kapha"}]},
  {id:"hair",text:"What is your hair type?",opts:[{l:"Vata",t:"Dry, brittle, frizzy",d:"vata"},{l:"Pitta",t:"Fine, oily, early grey",d:"pitta"},{l:"Kapha",t:"Thick, wavy, lustrous",d:"kapha"}]},
  {id:"appetite",text:"How is your appetite?",opts:[{l:"Vata",t:"Variable, erratic hunger",d:"vata"},{l:"Pitta",t:"Strong, can't skip meals",d:"pitta"},{l:"Kapha",t:"Low but steady appetite",d:"kapha"}]},
  {id:"sleep",text:"How do you sleep?",opts:[{l:"Vata",t:"Light, interrupted sleep",d:"vata"},{l:"Pitta",t:"Moderate, vivid dreams",d:"pitta"},{l:"Kapha",t:"Deep, heavy, long sleep",d:"kapha"}]},
  {id:"emotion",text:"Your dominant emotional trait?",opts:[{l:"Vata",t:"Anxious, creative",d:"vata"},{l:"Pitta",t:"Intense, driven, critical",d:"pitta"},{l:"Kapha",t:"Calm, patient, attached",d:"kapha"}]},
];
const DINFO={
  Vata:{color:"#4B7BAE",bg:"rgba(124,156,191,.12)",e:"üå¨Ô∏è",desc:"Air & Space element. Light, mobile, cold, dry qualities.",avoid:"Cold drinks, dry foods, raw vegetables",favor:"Warm cooked meals, ghee, grounding foods"},
  Pitta:{color:"#C4714A",bg:"rgba(196,113,74,.12)",e:"üî•",desc:"Fire & Water element. Sharp, hot, intense qualities.",avoid:"Spicy, fermented, sour, oily foods",favor:"Cool, sweet, bitter, astringent foods"},
  Kapha:{color:"#4A8E5A",bg:"rgba(123,174,132,.12)",e:"üåä",desc:"Earth & Water element. Heavy, cold, stable qualities.",avoid:"Heavy, oily, sweet, cold foods",favor:"Light, dry, warm, spicy stimulating foods"},
};
const MOCK=[
  {food:FOODS[0],conf:.91},{food:FOODS[1],conf:.87},{food:FOODS[5],conf:.93},
  {food:FOODS[7],conf:.85},{food:FOODS[10],conf:.89},{food:FOODS[13],conf:.88},
];

// ‚îÄ‚îÄ STORE & UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const store={
  get(k){try{return JSON.parse(localStorage.getItem(k))}catch{return null}},
  set(k,v){localStorage.setItem(k,JSON.stringify(v))},
  del(k){localStorage.removeItem(k)},
};
function el(id){return document.getElementById(id)}
function val(id){const e=el(id);return e?e.value:''}
function calcBMR(w,h,age,g){return Math.round(10*w+6.25*h-5*age+(g==='male'?5:-161))}
function calcTDEE(bmr,act){return Math.round(bmr*({sedentary:1.2,light:1.375,moderate:1.55,active:1.725,veryactive:1.9}[act]||1.375))}
function cap(s){return s?s.charAt(0).toUpperCase()+s.slice(1):''}
function fmtTime(ts){return new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
function fmtDate(ts){return new Date(ts).toDateString()}
function today(){return new Date().toDateString()}
function toast(msg){
  const t=document.createElement('div');t.className='toast';t.textContent=msg;
  document.body.appendChild(t);setTimeout(()=>t&&t.remove(),3000);
}
function mealPlan(user){
  const d=user.prakriti?user.prakriti.toLowerCase():null;
  const safe=d?FOODS.filter(f=>f[d]!=='aggravate'):FOODS;
  const tdee=user.tdee||2000;
  const pick=(target)=>{
    const sh=[...safe].sort(()=>Math.random()-.5);
    const out=[];let tot=0;
    for(const f of sh){if(tot+f.cal<=target+70&&out.length<3){out.push(f);tot+=f.cal}}
    return {items:out,total:tot};
  };
  return{bf:pick(Math.round(tdee*.3)),lu:pick(Math.round(tdee*.4)),di:pick(Math.round(tdee*.3)),tdee};
}

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let S={
  view:'landing',user:store.get('currentUser'),plan:null,
  scanResult:null,scanLogged:false,scanning:false,
  qStep:0,qAnswers:{},qDone:false,qResult:null,editProfile:false,
};
if(S.user) S.view='dashboard';

function set(patch){Object.assign(S,patch);render()}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render(){
  const app=el('app');
  if(S.view==='landing'){app.innerHTML=landing();return}
  if(S.view==='login'||S.view==='register'){app.innerHTML=authPage();return}
  if(!S.user){app.innerHTML=authPage();return}
  app.innerHTML='<div class="shell">'+sidebar()+'<main class="main">'+page()+'</main></div>';
}

function sidebar(){
  const u=S.user;
  const di=u.prakriti&&DINFO[u.prakriti];
  const navs=[['dashboard','üè†','Dashboard'],['assessment','üß¨','Assessment'],['mealplan','üçΩÔ∏è','Meal Plan'],
               ['scan','üì∏','Food Scanner'],['history','üìñ','History'],['analytics','üìä','Analytics'],['profile','üë§','Profile']];
  return `<nav class="sidebar">
    <div class="sb-logo"><h1>üåø AyurVeda AI</h1><small>Diet Planner</small></div>
    <div class="sb-nav">${navs.map(([id,ic,lb])=>`<div class="nav-item${S.view===id?' active':''}" onclick="nav('${id}')">${ic} ${lb}</div>`).join('')}</div>
    <div class="sb-user"><div class="flex aic gap2">
      <div class="sb-av">${(u.name||'U')[0].toUpperCase()}</div>
      <div>
        <div style="font-size:.83rem;font-weight:600;color:#fff">${(u.name||'').split(' ')[0]}</div>
        ${di?`<div style="font-size:.7rem;opacity:.7">${di.e} ${u.prakriti}</div>`:'<div style="font-size:.7rem;opacity:.55">No prakriti set</div>'}
      </div>
    </div></div>
  </nav>`;
}

function page(){
  switch(S.view){
    case'dashboard':return pgDashboard();
    case'assessment':return pgAssessment();
    case'mealplan':return pgMealPlan();
    case'scan':return pgScan();
    case'history':return pgHistory();
    case'analytics':return pgAnalytics();
    case'profile':return pgProfile();
    default:return pgDashboard();
  }
}

// ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function landing(){
  return `<div class="land">
    <div class="lnav">
      <div class="llogo">üåø AyurVeda AI</div>
      <div class="flex gap2">
        <button class="btn btn-o btn-sm" onclick="nav('login')">Sign In</button>
        <button class="btn btn-p btn-sm" onclick="nav('register')">Get Started</button>
      </div>
    </div>
    <div class="hero">
      <div>
        <div class="htag">‚ú® Ancient Wisdom √ó Modern AI</div>
        <h1 class="htitle">Your <span>Ayurvedic</span><br>Diet, Personalised.</h1>
        <p class="hsub">Discover your Prakriti, get AI-powered meal plans aligned with your dosha, and track your nutritional journey ‚Äî rooted in 5000-year-old Ayurvedic science.</p>
        <div class="hbtns">
          <button class="btn btn-p" onclick="nav('register')">üåø Start Free Assessment</button>
          <button class="btn btn-o" onclick="nav('login')">Sign In</button>
        </div>
      </div>
      <div class="hcard">
        <div style="text-align:center;margin-bottom:16px">
          <div style="font-size:2.5rem">üåø</div>
          <h3 style="font-size:1.2rem;margin:6px 0 4px">The Three Doshas</h3>
          <p style="font-family:Arial,sans-serif;font-size:.82rem;color:var(--muted)">Your unique body constitution</p>
        </div>
        ${Object.entries(DINFO).map(([d,i])=>`
          <div style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:9px;background:${i.bg};margin-bottom:7px">
            <span style="font-size:1.3rem">${i.e}</span>
            <div>
              <div style="font-weight:600;color:${i.color};font-family:Arial,sans-serif;font-size:.88rem">${d}</div>
              <div style="font-family:Arial,sans-serif;font-size:.76rem;color:var(--muted)">${i.desc}</div>
            </div>
          </div>`).join('')}
      </div>
    </div>
    <div class="features">
      <h2 style="font-size:1.85rem;text-align:center">Everything you need to eat right</h2>
      <div class="fg2">
        ${[['üß¨','Prakriti Assessment','6-question quiz to determine your Vata, Pitta & Kapha balance.'],
           ['üçΩÔ∏è','AI Meal Plans','Personalized breakfast, lunch & dinner generated for your dosha daily.'],
           ['üì∏','Food Recognition','Upload a photo to identify food and get dosha impact analysis.'],
           ['‚ö†Ô∏è','Dosha Warnings','Real-time alerts when logged food may aggravate your constitution.'],
           ['üìä','Macro Tracking','Weekly calorie & macro charts to visualize your nutritional journey.'],
           ['üåø','Ayurvedic Advisory','Smart food swap suggestions to keep your doshas balanced.'],
        ].map(([ic,t,d])=>`<div class="fc"><div class="ficon">${ic}</div><h4 class="ftitle">${t}</h4><p class="fdesc">${d}</p></div>`).join('')}
      </div>
    </div>
  </div>`;
}

function authPage(){
  const reg=S.view==='register';
  return `<div class="auth-wrap"><div class="auth-box">
    <h1>üåø AyurVeda AI</h1>
    <p class="sub">${reg?'Begin your wellness journey':'Welcome back'}</p>
    <div id="aerr"></div>
    ${reg?`<div class="fg"><label>Full Name</label><input type="text" id="an" placeholder="Arjun Sharma"/></div>`:''}
    <div class="fg"><label>Email</label><input type="email" id="ae" placeholder="you@example.com"/></div>
    <div class="fg"><label>Password</label><input type="password" id="ap" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
    ${reg?`
    <div class="g2">
      <div class="fg"><label>Age</label><input type="number" id="aa" placeholder="28"/></div>
      <div class="fg"><label>Gender</label><select id="ag"><option value="male">Male</option><option value="female">Female</option></select></div>
    </div>
    <div class="g2">
      <div class="fg"><label>Height (cm)</label><input type="number" id="ah" placeholder="170"/></div>
      <div class="fg"><label>Weight (kg)</label><input type="number" id="aw" placeholder="65"/></div>
    </div>
    <div class="fg"><label>Activity Level</label><select id="aact">
      <option value="sedentary">Sedentary</option><option value="light">Light (1-3x/wk)</option>
      <option value="moderate" selected>Moderate (3-5x/wk)</option><option value="active">Active (6-7x/wk)</option>
      <option value="veryactive">Very Active</option>
    </select></div>`:''}
    <button class="btn btn-p btn-full" onclick="doAuth()" style="margin-top:6px">${reg?'Create Account ‚Üí':'Sign In ‚Üí'}</button>
    <p style="text-align:center;margin-top:16px;font-family:Arial,sans-serif;font-size:.84rem;color:var(--muted)">
      ${reg?'Already have an account? ':'No account? '}
      <span style="color:var(--green);cursor:pointer;font-weight:600" onclick="nav('${reg?'login':'register'}')">${reg?'Sign in ‚Üí':'Register ‚Üí'}</span>
    </p>
  </div></div>`;
}

function pgDashboard(){
  const u=S.user,logs=store.get('logs_'+u.id)||[];
  const tl=logs.filter(l=>fmtDate(l.ts)===today());
  const totCal=tl.reduce((s,l)=>s+l.cal,0);
  const totP=tl.reduce((s,l)=>s+l.protein,0);
  const totC=tl.reduce((s,l)=>s+l.carbs,0);
  const totF=tl.reduce((s,l)=>s+l.fats,0);
  const pct=Math.min(100,Math.round((totCal/(u.tdee||2000))*100));
  const di=u.prakriti&&DINFO[u.prakriti];
  const avoid=u.prakriti?FOODS.filter(f=>f[u.prakriti.toLowerCase()]==='aggravate'):[];
  return `
  <div class="ph"><h2>Namaste, ${(u.name||'').split(' ')[0]} üôè</h2><p>Your wellness overview for today</p></div>
  ${!u.prakriti?`<div class="al ai" style="cursor:pointer" onclick="nav('assessment')">üå± <span><strong>Complete your Prakriti assessment</strong> to unlock personalized meal plans. Click here ‚Üí</span></div>`:''}
  ${di?`<div class="al as">${di.e} Your Prakriti: <strong style="margin:0 4px">${u.prakriti}</strong> ‚Äî Follow your dosha diet for optimal health</div>`:''}
  <div class="g4" style="margin-bottom:18px">
    <div class="stat">
      <div class="sl">Calories Today</div>
      <div class="sv">${totCal}<span class="su"> / ${u.tdee||2000}</span></div>
      <div class="pb mt2"><div class="pf" style="width:${pct}%;background:${pct>100?'var(--pitta)':'var(--green)'}"></div></div>
    </div>
    <div class="stat"><div class="sl">Protein</div><div class="sv">${totP}<span class="su">g</span></div></div>
    <div class="stat"><div class="sl">Carbs</div><div class="sv">${totC}<span class="su">g</span></div></div>
    <div class="stat"><div class="sl">Fats</div><div class="sv">${totF}<span class="su">g</span></div></div>
  </div>
  <div class="g2" style="margin-bottom:18px">
    <div class="card">
      <h3 class="ct">Today's Meals</h3>
      <p class="cs">${tl.length} items tracked today</p>
      ${tl.length===0?`<div style="text-align:center;padding:20px 0;color:var(--muted);font-family:Arial,sans-serif;font-size:.86rem">
        <div style="font-size:2rem;margin-bottom:8px">üçΩÔ∏è</div>No meals logged yet.
        <br><button class="btn btn-o btn-sm mt2" onclick="nav('scan')">Log Food</button></div>`:
        tl.slice(-4).map(l=>`<div class="li mt2">
          <div><div style="font-weight:600;font-size:.87rem">${l.e} ${l.name}</div><div class="lt">${fmtTime(l.ts)}</div></div>
          <div style="font-family:Arial,sans-serif;font-size:.8rem;color:var(--muted)">${l.cal} kcal</div>
        </div>`).join('')}
    </div>
    <div class="card">
      <h3 class="ct">Quick Actions</h3>
      <p class="cs">Navigate to key features</p>
      <div style="display:flex;flex-direction:column;gap:8px">
        ${[['üì∏','Scan Food','scan'],['üçΩÔ∏è','Meal Plan','mealplan'],['üìä','Analytics','analytics'],['üìñ','History','history']]
          .map(([ic,lb,pg])=>`<button class="btn btn-o btn-sm" style="justify-content:flex-start" onclick="nav('${pg}')">${ic} ${lb}</button>`).join('')}
      </div>
    </div>
  </div>
  ${avoid.length?`<div class="card">
    <h3 class="ct">Foods to Avoid ‚Äî ${u.prakriti}</h3>
    <p class="cs">These foods may aggravate your dosha</p>
    <div class="flex wrap gap2 mt2">${avoid.map(f=>`<span class="db dp">${f.e} ${f.name}</span>`).join('')}</div>
  </div>`:''}`;
}

function pgAssessment(){
  if(S.qDone&&S.qResult) return assessResult();
  const q=QUESTIONS[S.qStep];
  const prog=Math.round(S.qStep/QUESTIONS.length*100);
  return `
  <div class="ph"><h2>Prakriti Assessment</h2><p>Discover your Ayurvedic body constitution in 6 questions</p></div>
  <div class="pb" style="margin-bottom:18px"><div class="pf" style="width:${prog}%"></div></div>
  <p style="font-family:Arial,sans-serif;font-size:.84rem;color:var(--muted);margin-bottom:16px">Question ${S.qStep+1} of ${QUESTIONS.length}</p>
  <div class="qcard">
    <div class="qt">${q.text}</div>
    <div class="og">
      ${q.opts.map(o=>`<button class="ob${S.qAnswers[q.id]===o.d?' sel':''}" onclick="pickOpt('${q.id}','${o.d}')">
        <div class="ol">${o.l}</div><div>${o.t}</div>
      </button>`).join('')}
    </div>
  </div>`;
}

function assessResult(){
  const r=S.qResult,di=DINFO[r.dominant];
  const maxS=Math.max(...Object.values(r.scores));
  return `
  <div class="ph"><h2>Your Prakriti Result</h2><p>Based on your answers</p></div>
  <div class="drc">
    <div class="di">${di.e}</div>
    <div class="dn">${r.dominant} Prakriti</div>
    <p style="font-family:Arial,sans-serif;font-size:.86rem;color:var(--muted);max-width:380px;margin:0 auto">${di.desc}</p>
    <div class="sb2">
      ${['Vata','Pitta','Kapha'].map(d=>{
        const sc=r.scores[d.toLowerCase()]||0;
        const pct=maxS?Math.round(sc/maxS*100):0;
        return `<div class="sbi">
          <div class="sbl">${d}</div>
          <div class="sbt"><div class="sbf ${d.toLowerCase()}" style="width:${pct}%"></div></div>
          <div class="spct" style="color:${DINFO[d].color}">${sc}</div>
        </div>`;}).join('')}
    </div>
  </div>
  <div class="g2" style="margin-bottom:18px">
    <div class="card"><h4 class="ct">‚ö†Ô∏è Foods to Avoid</h4><p style="font-family:Arial,sans-serif;font-size:.85rem;color:var(--muted);line-height:1.6;margin-top:7px">${di.avoid}</p></div>
    <div class="card"><h4 class="ct">‚úÖ Recommended Foods</h4><p style="font-family:Arial,sans-serif;font-size:.85rem;color:var(--muted);line-height:1.6;margin-top:7px">${di.favor}</p></div>
  </div>
  <button class="btn btn-p" onclick="saveAssessment()">üåø Save & Go to Dashboard ‚Üí</button>`;
}

function pgMealPlan(){
  const u=S.user;
  if(!u.prakriti) return `<div class="ph"><h2>Meal Plan</h2></div>
    <div class="card" style="text-align:center;padding:44px">
      <div style="font-size:2.5rem;margin-bottom:12px">üå±</div>
      <h3>Complete Your Assessment First</h3>
      <p style="font-family:Arial,sans-serif;color:var(--muted);margin-top:7px">Your meal plan is personalized based on your Prakriti</p>
      <button class="btn btn-p mt3" onclick="nav('assessment')">Take Assessment ‚Üí</button>
    </div>`;
  if(!S.plan) S.plan=mealPlan(u);
  const p=S.plan;
  const meals=[{name:'Breakfast',icon:'üåÖ',data:p.bf},{name:'Lunch',icon:'‚òÄÔ∏è',data:p.lu},{name:'Dinner',icon:'üåô',data:p.di}];
  const totCal=meals.reduce((s,m)=>s+m.data.total,0);
  return `
  <div class="ph flex jb aic">
    <div><h2>Today's Meal Plan</h2><p>Personalized for ${u.prakriti} ¬∑ ${p.tdee} kcal target</p></div>
    <button class="btn btn-o btn-sm" onclick="regenPlan()">üîÑ Regenerate</button>
  </div>
  ${meals.map(m=>`
    <div style="margin-bottom:22px">
      <div class="flex aic gap3" style="margin-bottom:11px">
        <span style="font-size:1.15rem">${m.icon}</span>
        <h3 style="font-size:1.1rem">${m.name}</h3>
        <span style="color:var(--muted);font-size:.8rem;margin-left:auto;font-family:Arial,sans-serif">~${m.data.total} kcal</span>
        <button class="btn btn-o btn-sm" onclick="logMeal(${m.data.items.map(f=>f.id).join(',')})">Log All</button>
      </div>
      ${m.data.items.map(f=>{
        const eff=f[u.prakriti.toLowerCase()];
        return `<div class="fi">
          <div class="flex aic gap3">
            <span style="font-size:1.15rem">${f.e}</span>
            <div><div class="fn">${f.name}</div><div class="fm"><span>P:${f.protein}g</span><span>C:${f.carbs}g</span><span>F:${f.fats}g</span></div></div>
          </div>
          <div class="flex aic gap2">
            ${eff==='pacify'?'<span class="db dk">‚úÖ Pacifying</span>':eff==='neutral'?'<span style="font-size:.74rem;color:var(--muted);font-family:Arial,sans-serif">Neutral</span>':''}
            <span style="font-family:Arial,sans-serif;font-size:.82rem;color:var(--muted)">${f.cal} kcal</span>
          </div>
        </div>`;}).join('')}
    </div>`).join('')}
  <div class="card">
    <div class="flex jb aic">
      <div><h4>Daily Total</h4><p style="font-family:Arial,sans-serif;font-size:.8rem;color:var(--muted)">Across all 3 meals</p></div>
      <div style="text-align:right">
        <div style="font-size:1.8rem">${totCal} kcal</div>
        <div style="font-family:Arial,sans-serif;font-size:.78rem;color:var(--muted)">Target: ${p.tdee} kcal</div>
      </div>
    </div>
  </div>`;
}

function pgScan(){
  const u=S.user,sr=S.scanResult;
  return `
  <div class="ph"><h2>AI Food Scanner</h2><p>Upload a food photo for instant recognition and dosha analysis</p></div>
  <div class="card" style="margin-bottom:18px">
    <div class="sz${S.scanning?' sc':''}" onclick="el('sfile')&&el('sfile').click()">
      <input type="file" id="sfile" accept="image/*" style="display:none" onchange="handleScan(this)"/>
      <div class="si">${S.scanning?'‚è≥':'üì∏'}</div>
      ${S.scanning?'<p style="color:var(--green);font-weight:600;font-family:Arial,sans-serif">Analyzing your food‚Ä¶</p>':
        `<p style="font-weight:600;font-family:Arial,sans-serif;margin-bottom:5px">Click to upload food photo</p>
         <p style="font-family:Arial,sans-serif;font-size:.81rem;color:var(--muted)">Supports JPG, PNG, WEBP</p>
         <button class="btn btn-p btn-sm" style="margin-top:13px;pointer-events:none">üì§ Upload Image</button>`}
    </div>
  </div>
  ${sr?`<div class="card">
    <div class="flex jb aic" style="margin-bottom:13px">
      <h3 style="font-size:1.35rem">${sr.food.e} ${sr.food.name}</h3>
      <span class="db dk">AI Match</span>
    </div>
    <div style="margin-bottom:13px">
      <div class="flex jb" style="margin-bottom:3px;font-family:Arial,sans-serif;font-size:.81rem">
        <span style="color:var(--muted)">Confidence</span><span style="font-weight:700">${Math.round(sr.conf*100)}%</span>
      </div>
      <div class="pb"><div class="pf" style="width:${sr.conf*100}%"></div></div>
    </div>
    <div class="g4" style="margin-bottom:16px">
      ${[['Calories',sr.food.cal,'kcal'],['Protein',sr.food.protein,'g'],['Carbs',sr.food.carbs,'g'],['Fats',sr.food.fats,'g']]
        .map(([lb,v,u2])=>`<div style="text-align:center;padding:11px;background:var(--bg);border-radius:9px;border:1px solid var(--border)">
          <div style="font-family:Arial,sans-serif;font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:.4px">${lb}</div>
          <div style="font-size:1.45rem">${v}<span style="font-size:.77rem;color:var(--muted)">${u2}</span></div>
        </div>`).join('')}
    </div>
    ${u.prakriti?(()=>{
      const eff=sr.food[u.prakriti.toLowerCase()];
      const alt=FOODS.find(f=>f[u.prakriti.toLowerCase()]==='pacify'&&f.id!==sr.food.id);
      if(eff==='aggravate') return `<div class="al aw" style="margin-bottom:13px">‚ö†Ô∏è <span><strong>${sr.food.name}</strong> may aggravate your ${u.prakriti} dosha.${alt?` Consider <strong>${alt.name}</strong> instead.`:''}</span></div>`;
      if(eff==='pacify') return `<div class="al as" style="margin-bottom:13px">‚úÖ Great choice! This food pacifies your ${u.prakriti} dosha.</div>`;
      return `<div class="al ai" style="margin-bottom:13px">‚ÑπÔ∏è Neutral effect on your ${u.prakriti} dosha.</div>`;
    })():''}
    <div class="flex gap2">
      <button class="btn btn-p" onclick="logScanned()" ${S.scanLogged?'disabled':''}>${S.scanLogged?'‚úÖ Logged!':'+ Log this Food'}</button>
      <button class="btn btn-o" onclick="clearScan()">üîÑ Scan Another</button>
    </div>
  </div>`:''}`;
}

function pgHistory(){
  const u=S.user,logs=store.get('logs_'+u.id)||[];
  if(!logs.length) return `
    <div class="ph"><h2>Food History</h2><p>Your complete nutrition log</p></div>
    <div class="card" style="text-align:center;padding:44px">
      <div style="font-size:2.5rem;margin-bottom:12px">üìñ</div>
      <h3>No History Yet</h3>
      <p style="font-family:Arial,sans-serif;color:var(--muted);margin-top:7px">Start logging food to see your history</p>
    </div>`;
  const grp={};
  logs.forEach(l=>{const d=fmtDate(l.ts);if(!grp[d])grp[d]=[];grp[d].push(l);});
  return `
  <div class="ph"><h2>Food History</h2><p>Your complete nutrition log</p></div>
  ${Object.entries(grp).reverse().map(([date,items])=>{
    const totCal=items.reduce((s,l)=>s+l.cal,0);
    return `<div class="card" style="margin-bottom:16px">
      <div class="flex jb aic" style="margin-bottom:13px">
        <div>
          <h4 style="font-size:1.1rem">${date}</h4>
          <p style="font-family:Arial,sans-serif;font-size:.78rem;color:var(--muted)">${items.length} items ¬∑ ${totCal} kcal</p>
        </div>
        <button class="btn btn-red btn-sm" onclick="clearDay('${date}')">Clear Day</button>
      </div>
      ${items.map(l=>{
        const eff=u.prakriti?l[u.prakriti.toLowerCase()]:null;
        return `<div class="li mt2">
          <div class="flex aic gap3">
            <span style="font-size:1rem">${l.e}</span>
            <div><div style="font-weight:600;font-size:.86rem">${l.name}</div><div class="lt">${fmtTime(l.ts)}</div></div>
          </div>
          <div class="flex aic gap2 wrap">
            ${eff==='aggravate'?`<span style="background:rgba(196,113,74,.1);color:var(--warn);font-size:.72rem;padding:2px 8px;border-radius:6px;font-family:Arial,sans-serif">‚ö†Ô∏è Aggravates</span>`:''}
            ${eff==='pacify'?`<span style="background:rgba(79,111,82,.1);color:var(--green);font-size:.72rem;padding:2px 8px;border-radius:6px;font-family:Arial,sans-serif">‚úÖ Pacifying</span>`:''}
            <span style="font-family:Arial,sans-serif;font-size:.78rem;color:var(--muted)">${l.cal}kcal P:${l.protein}g C:${l.carbs}g F:${l.fats}g</span>
          </div>
        </div>`;}).join('')}
    </div>`;}).join('')}`;
}

function pgAnalytics(){
  const u=S.user,logs=store.get('logs_'+u.id)||[];
  const labels=[],calA=[],protA=[],carbA=[],fatA=[];
  for(let i=6;i>=0;i--){
    const d=new Date();d.setDate(d.getDate()-i);
    const ds=d.toDateString();
    const dl=logs.filter(l=>fmtDate(l.ts)===ds);
    labels.push(d.toLocaleDateString('en',{weekday:'short',day:'numeric'}));
    calA.push(dl.reduce((s,l)=>s+l.cal,0));
    protA.push(dl.reduce((s,l)=>s+l.protein,0));
    carbA.push(dl.reduce((s,l)=>s+l.carbs,0));
    fatA.push(dl.reduce((s,l)=>s+l.fats,0));
  }
  const totCal=calA.reduce((a,b)=>a+b,0);
  const avgCal=Math.round(totCal/7);
  const daysLogged=calA.filter(v=>v>0).length;
  const pacify=u.prakriti?logs.filter(l=>l[u.prakriti.toLowerCase()]==='pacify').length:0;
  const aggr=u.prakriti?logs.filter(l=>l[u.prakriti.toLowerCase()]==='aggravate').length:0;
  const comp=logs.length?Math.round(pacify/logs.length*100):0;
  const maxCal=Math.max(...calA,1);
  const maxM=Math.max(...protA,...carbA,...fatA,1);
  return `
  <div class="ph"><h2>Analytics</h2><p>Your 7-day nutrition overview</p></div>
  <div class="g4" style="margin-bottom:18px">
    <div class="stat"><div class="sl">Weekly Calories</div><div class="sv">${totCal.toLocaleString()}</div></div>
    <div class="stat"><div class="sl">Daily Average</div><div class="sv">${avgCal}<span class="su">kcal</span></div></div>
    <div class="stat"><div class="sl">Days Tracked</div><div class="sv">${daysLogged}<span class="su">/7</span></div></div>
    <div class="stat"><div class="sl">Daily Target</div><div class="sv">${u.tdee||2000}<span class="su">kcal</span></div></div>
  </div>
  <div class="card" style="margin-bottom:18px">
    <h3 class="ct">7-Day Calorie Chart</h3>
    <p class="cs">Daily calories ¬∑ bars indicate total intake</p>
    <div style="display:flex;align-items:flex-end;gap:5px;height:160px;padding:0 2px;margin-bottom:10px">
      ${calA.map((v,i)=>{
        const h=v?Math.max(4,Math.round(v/maxCal*140)):0;
        return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:3px">
          <div style="font-family:Arial,sans-serif;font-size:.64rem;color:var(--muted)">${v||''}</div>
          <div style="width:100%;height:${h}px;background:var(--green);border-radius:4px 4px 0 0;opacity:.85"></div>
          <div style="font-family:Arial,sans-serif;font-size:.62rem;color:var(--muted);text-align:center">${labels[i]}</div>
        </div>`;}).join('')}
    </div>
    <h4 style="font-size:.9rem;margin-bottom:8px;color:var(--muted);font-family:Arial,sans-serif">Macros (Protein ¬∑ Carbs ¬∑ Fats)</h4>
    <div style="display:flex;align-items:flex-end;gap:5px;height:90px;padding:0 2px;margin-bottom:8px">
      ${protA.map((_,i)=>{
        const hp=protA[i]?Math.max(3,Math.round(protA[i]/maxM*80)):0;
        const hc=carbA[i]?Math.max(3,Math.round(carbA[i]/maxM*80)):0;
        const hf=fatA[i]?Math.max(3,Math.round(fatA[i]/maxM*80)):0;
        return `<div style="flex:1;display:flex;align-items:flex-end;gap:1px;height:80px">
          <div style="flex:1;height:${hp}px;background:var(--vata);border-radius:2px 2px 0 0"></div>
          <div style="flex:1;height:${hc}px;background:var(--pitta);border-radius:2px 2px 0 0;opacity:.8"></div>
          <div style="flex:1;height:${hf}px;background:var(--brown);border-radius:2px 2px 0 0;opacity:.75"></div>
        </div>`;}).join('')}
    </div>
    <div class="flex gap3" style="font-family:Arial,sans-serif;font-size:.76rem;color:var(--muted)">
      <span><span style="display:inline-block;width:9px;height:9px;background:var(--vata);border-radius:2px;margin-right:4px"></span>Protein</span>
      <span><span style="display:inline-block;width:9px;height:9px;background:var(--pitta);border-radius:2px;margin-right:4px"></span>Carbs</span>
      <span><span style="display:inline-block;width:9px;height:9px;background:var(--brown);border-radius:2px;margin-right:4px"></span>Fats</span>
    </div>
  </div>
  ${u.prakriti?`<div class="card">
    <h3 class="ct">Dosha Compliance</h3>
    <p class="cs">Alignment with your ${u.prakriti} constitution</p>
    <div class="g3" style="margin-top:13px">
      <div style="text-align:center;padding:15px;background:rgba(79,111,82,.08);border-radius:10px">
        <div style="font-size:1.8rem;color:var(--green)">${pacify}</div>
        <div style="font-family:Arial,sans-serif;font-size:.76rem;color:var(--muted)">Pacifying Foods</div>
      </div>
      <div style="text-align:center;padding:15px;background:rgba(196,113,74,.08);border-radius:10px">
        <div style="font-size:1.8rem;color:var(--pitta)">${aggr}</div>
        <div style="font-family:Arial,sans-serif;font-size:.76rem;color:var(--muted)">Aggravating Foods</div>
      </div>
      <div style="text-align:center;padding:15px;background:rgba(124,156,191,.08);border-radius:10px">
        <div style="font-size:1.8rem;color:var(--vata)">${comp}%</div>
        <div style="font-family:Arial,sans-serif;font-size:.76rem;color:var(--muted)">Compliance Score</div>
      </div>
    </div>
  </div>`:''}`;
}

function pgProfile(){
  const u=S.user,di=u.prakriti&&DINFO[u.prakriti];
  if(S.editProfile) return `
    <div class="ph"><h2>Edit Profile</h2></div>
    <div class="card" style="max-width:500px">
      <div class="fg"><label>Name</label><input type="text" id="pn" value="${u.name||''}"/></div>
      <div class="g2">
        <div class="fg"><label>Age</label><input type="number" id="pa" value="${u.age||''}"/></div>
        <div class="fg"><label>Height (cm)</label><input type="number" id="ph" value="${u.height||''}"/></div>
      </div>
      <div class="g2">
        <div class="fg"><label>Weight (kg)</label><input type="number" id="pw" value="${u.weight||''}"/></div>
        <div class="fg"><label>Activity</label><select id="pact">
          ${['sedentary','light','moderate','active','veryactive'].map(v=>`<option value="${v}"${u.activity_level===v?' selected':''}>${cap(v)}</option>`).join('')}
        </select></div>
      </div>
      <div class="flex gap2 mt2">
        <button class="btn btn-p" onclick="saveProfile()">Save Changes</button>
        <button class="btn btn-o" onclick="set({editProfile:false})">Cancel</button>
      </div>
    </div>`;
  const fields=[['Age',(u.age||'‚Äî')+' years'],['Gender',cap(u.gender||'')],
    ['Height',(u.height||'‚Äî')+' cm'],['Weight',(u.weight||'‚Äî')+' kg'],
    ['Activity',cap(u.activity_level||'')],['BMR',(u.bmr||0)+' kcal'],
    ['Daily Target (TDEE)',(u.tdee||0)+' kcal'],['Member Since',new Date(u.created_at||Date.now()).toLocaleDateString()]];
  return `
  <div class="ph"><h2>Profile</h2><p>Your account and wellness details</p></div>
  <div class="g2">
    <div>
      <div class="card" style="text-align:center;margin-bottom:16px">
        <div class="pav" style="margin:0 auto 11px">${(u.name||'U')[0].toUpperCase()}</div>
        <h3 style="font-size:1.3rem">${u.name}</h3>
        <p style="font-family:Arial,sans-serif;font-size:.81rem;color:var(--muted);margin-top:3px">${u.email}</p>
        ${di?`<div style="margin-top:13px"><span class="db ${u.prakriti==='Vata'?'dv':u.prakriti==='Pitta'?'dp':'dk'}" style="font-size:.86rem;padding:5px 13px">${di.e} ${u.prakriti} Prakriti</span></div>`:''}
      </div>
      ${di?`<div class="card">
        <h4 class="ct" style="margin-bottom:9px">Your Dosha</h4>
        <div style="background:${di.bg};border-radius:9px;padding:13px">
          <p style="font-family:Arial,sans-serif;font-size:.82rem;margin-bottom:7px"><strong>Avoid:</strong> ${di.avoid}</p>
          <p style="font-family:Arial,sans-serif;font-size:.82rem"><strong>Favor:</strong> ${di.favor}</p>
        </div>
      </div>`:''}
    </div>
    <div class="card">
      <div class="flex jb aic" style="margin-bottom:16px">
        <h3 class="ct" style="margin:0">Personal Details</h3>
        <button class="btn btn-o btn-sm" onclick="set({editProfile:true})">‚úèÔ∏è Edit</button>
      </div>
      <div class="g2">
        ${fields.map(([lb,v])=>`<div style="padding:11px;background:var(--bg);border-radius:8px">
          <div style="font-family:Arial,sans-serif;font-size:.7rem;text-transform:uppercase;letter-spacing:.4px;color:var(--muted);margin-bottom:2px">${lb}</div>
          <div style="font-weight:600;font-size:.88rem">${v}</div>
        </div>`).join('')}
      </div>
      <div class="divider"></div>
      <button class="btn btn-red btn-sm" onclick="doLogout()">Sign Out</button>
    </div>
  </div>`;
}

// ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function nav(v){set({view:v,qStep:0,qAnswers:{},qDone:false,qResult:null,scanResult:null,scanLogged:false,scanning:false,editProfile:false})}

function doAuth(){
  const reg=S.view==='register';
  const email=val('ae'),pass=val('ap'),errEl=el('aerr');
  const showErr=m=>{if(errEl)errEl.innerHTML=`<div class="al aw">${m}</div>`};
  if(!email||!pass){showErr('Please fill all required fields.');return}
  if(reg){
    const name=val('an');
    if(!name){showErr('Name is required.');return}
    const users=store.get('users')||[];
    if(users.find(u=>u.email===email)){showErr('Email already registered.');return}
    const age=parseInt(val('aa'))||25,gender=val('ag')||'male',height=parseFloat(val('ah'))||170,weight=parseFloat(val('aw'))||65,act=val('aact')||'moderate';
    const bmr=calcBMR(weight,height,age,gender),tdee=calcTDEE(bmr,act);
    const user={id:Date.now(),name,email,password:pass,age,gender,height,weight,activity_level:act,bmr,tdee,prakriti:null,created_at:new Date().toISOString()};
    users.push(user);store.set('users',users);store.set('currentUser',user);
    set({user,view:'dashboard'});
  } else {
    const users=store.get('users')||[];
    const user=users.find(u=>u.email===email&&u.password===pass);
    if(!user){showErr('Invalid email or password.');return}
    store.set('currentUser',user);set({user,view:'dashboard'});
  }
}

function doLogout(){store.del('currentUser');set({user:null,view:'landing',plan:null})}

function pickOpt(qid,dosha){
  const newAns={...S.qAnswers,[qid]:dosha};
  if(S.qStep<QUESTIONS.length-1){set({qAnswers:newAns,qStep:S.qStep+1})}
  else{
    const scores={vata:0,pitta:0,kapha:0};
    Object.values(newAns).forEach(d=>scores[d]++);
    const dominant=cap(Object.entries(scores).sort((a,b)=>b[1]-a[1])[0][0]);
    set({qAnswers:newAns,qDone:true,qResult:{dominant,scores}});
  }
}

function saveAssessment(){
  const r=S.qResult;
  const users=store.get('users')||[];
  const idx=users.findIndex(u=>u.id===S.user.id);
  if(idx>=0){users[idx].prakriti=r.dominant;store.set('users',users);store.set('currentUser',users[idx]);}
  toast('üåø Prakriti saved: '+r.dominant);
  set({user:{...S.user,prakriti:r.dominant},view:'dashboard',plan:null});
}

function regenPlan(){set({plan:mealPlan(S.user)})}

function logMeal(...ids){
  const logs=store.get('logs_'+S.user.id)||[];
  ids.forEach(id=>{const f=FOODS.find(x=>x.id===id);if(f)logs.push({...f,ts:Date.now()})});
  store.set('logs_'+S.user.id,logs);toast('‚úÖ Meal logged!');render();
}

function handleScan(input){
  if(!input.files||!input.files[0])return;
  set({scanning:true,scanResult:null,scanLogged:false});
  setTimeout(()=>{
    const mock=MOCK[Math.floor(Math.random()*MOCK.length)];
    set({scanning:false,scanResult:mock});
  },1800);
}

function logScanned(){
  if(!S.scanResult)return;
  const f=S.scanResult.food,logs=store.get('logs_'+S.user.id)||[];
  logs.push({...f,ts:Date.now()});
  store.set('logs_'+S.user.id,logs);
  toast('‚úÖ Food logged successfully!');
  set({scanLogged:true});
}

function clearScan(){set({scanResult:null,scanLogged:false,scanning:false})}

function clearDay(date){
  const logs=store.get('logs_'+S.user.id)||[];
  store.set('logs_'+S.user.id,logs.filter(l=>fmtDate(l.ts)!==date));
  render();
}

function saveProfile(){
  const name=val('pn')||S.user.name,age=parseInt(val('pa'))||S.user.age;
  const height=parseFloat(val('ph'))||S.user.height,weight=parseFloat(val('pw'))||S.user.weight;
  const act=val('pact')||S.user.activity_level;
  const bmr=calcBMR(weight,height,age,S.user.gender),tdee=calcTDEE(bmr,act);
  const updated={...S.user,name,age,height,weight,activity_level:act,bmr,tdee};
  const users=store.get('users')||[];
  const idx=users.findIndex(u=>u.id===updated.id);
  if(idx>=0){users[idx]=updated;store.set('users',users);}
  store.set('currentUser',updated);
  toast('‚úÖ Profile updated');
  set({user:updated,editProfile:false,plan:null});
}

render();
</script>
</body>
</html>
